trigger:
  branches:
    include:
      - dev

variables:
  terraformVersion: '1.6.6'
  azureServiceConnection: 'azureSC-terrafom'  # ðŸ‘ˆ Replace this with your actual service connection name
  backendResourceGroup: 'rg-pp-001'
  backendStorageAccount: 'ppplatformstorageaccount'
  backendContainerName: 'dev-tfstate'
  backendKey: 'dev.terraform.tfstate'
  environment: 'dev'
  workingDirectory: 'iac/azure/env/dev'  # ðŸ‘ˆ Your Terraform code path

stages:
  - stage: Terraform_Validate_Plan
    displayName: "Terraform Init, Validate, and Plan"
    jobs:
      - job: TerraformPlan
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self  # âœ… Pulls code from the repo

          - task: TerraformInstaller@0
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: '$(terraformVersion)'

          - task: TerraformCLI@0
            displayName: 'Terraform Init'
            inputs:
              provider: 'azurerm'
              command: 'init'
              workingDirectory: '$(workingDirectory)'
              backendServiceArm: '$(azureServiceConnection)'
              backendAzureRmResourceGroupName: '$(backendResourceGroup)'
              backendAzureRmStorageAccountName: '$(backendStorageAccount)'
              backendAzureRmContainerName: '$(backendContainerName)'
              backendAzureRmKey: '$(backendKey)'

          - task: TerraformCLI@0
            displayName: 'Terraform Validate'
            inputs:
              provider: 'azurerm'
              command: 'validate'
              workingDirectory: '$(workingDirectory)'

          - task: TerraformCLI@0
            displayName: 'Terraform Plan'
            inputs:
              provider: 'azurerm'
              command: 'plan'
              workingDirectory: '$(workingDirectory)'
              environmentServiceNameAzureRM: '$(azureServiceConnection)'
              backendServiceArm: '$(azureServiceConnection)'
              backendAzureRmResourceGroupName: '$(backendResourceGroup)'
              backendAzureRmStorageAccountName: '$(backendStorageAccount)'
              backendAzureRmContainerName: '$(backendContainerName)'
              backendAzureRmKey: '$(backendKey)'
              vars: |
                environment=$(environment)

  - stage: Terraform_Apply
    displayName: "Terraform Apply"
    dependsOn: Terraform_Validate_Plan
    condition: succeeded()
    jobs:
      - job: TerraformApply
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          - task: TerraformInstaller@0
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: '$(terraformVersion)'

          - task: TerraformCLI@0
            displayName: 'Terraform Apply'
            inputs:
              provider: 'azurerm'
              command: 'apply'
              workingDirectory: '$(workingDirectory)'
              environmentServiceNameAzureRM: '$(azureServiceConnection)'
              backendServiceArm: '$(azureServiceConnection)'
              backendAzureRmResourceGroupName: '$(backendResourceGroup)'
              backendAzureRmStorageAccountName: '$(backendStorageAccount)'
              backendAzureRmContainerName: '$(backendContainerName)'
              backendAzureRmKey: '$(backendKey)'
              vars: |
                environment=$(environment)
              autoApprove: true
